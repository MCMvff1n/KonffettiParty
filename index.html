<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Konfetti Party</title>

<style>
body {
  margin: 0;
  background: #222;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  flex-direction: column;
  font-family: sans-serif;
  color: white;
  user-select: none;
  touch-action: none;
}

#hud {
  margin-bottom: 10px;
  text-align: center;
}

#hud span {
  margin: 0 10px;
  font-weight: bold;
}

#game {
  display: grid;
  grid-template-columns: repeat(8, 35px);
  grid-template-rows: repeat(8, 35px);
  gap: 3px;
}

.tile {
  width: 35px;
  height: 35px;
  border-radius: 6px;
  box-shadow: inset 0 0 6px #0005;
}

.tile.selected {
  outline: 2px solid white;
  transform: scale(1.1);
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 10;
}

#gameOver {
  margin-top: 15px;
  font-size: 22px;
  color: #f1c40f;
  display: none;
}

button {
  margin-top: 8px;
  padding: 8px 16px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #3498db;
  color: white;
}
</style>
</head>

<body>

<div id="hud">
  <span id="time">‚è± 60s</span>
  <span id="score">‚≠ê 0</span>
  <span id="highscore">üèÜ 0</span>
</div>

<div id="game"></div>
<div id="gameOver">Game Over</div>
<button id="restart" style="display:none;">Neu starten</button>

<canvas id="canvas"></canvas>

<script>
const SIZE = 8;
const COLORS = ['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6'];

let board = [];
let selected = [];
let dragging = false;
let pointer = null;

let timeLeft = 60;
let score = 0;
let highscore = Number(localStorage.getItem("highscore")) || 0;

const game = document.getElementById("game");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const timeEl = document.getElementById("time");
const scoreEl = document.getElementById("score");
const highscoreEl = document.getElementById("highscore");
const gameOverEl = document.getElementById("gameOver");
const restartBtn = document.getElementById("restart");

highscoreEl.textContent = "üèÜ " + highscore;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function createBoard() {
  board = [];
  game.innerHTML = "";
  for (let y=0; y<SIZE; y++) {
    board[y] = [];
    for (let x=0; x<SIZE; x++) {
      const c = Math.floor(Math.random()*COLORS.length);
      board[y][x] = c;
      const d = document.createElement("div");
      d.className = "tile";
      d.style.background = COLORS[c];
      d.dataset.x = x;
      d.dataset.y = y;
      game.appendChild(d);
    }
  }
}

function getTile(x,y){
  return game.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
}

function neighbors(a,b){
  const dx = Math.abs(a.x - b.x);
  const dy = Math.abs(a.y - b.y);
  return dx <= 1 && dy <= 1 && !(dx === 0 && dy === 0);
}

function pointerPos(e){
  const t = e.touches ? e.touches[0] : e;
  return {x:t.clientX, y:t.clientY};
}

function tileAt(pos){
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      const el = getTile(x,y);
      const r = el.getBoundingClientRect();
      if(pos.x>=r.left && pos.x<=r.right && pos.y>=r.top && pos.y<=r.bottom){
        return {x,y,color:board[y][x]};
      }
    }
  }
  return null;
}

function drawLine(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(selected.length<2) return;
  ctx.strokeStyle="white";
  ctx.lineWidth=3;
  ctx.lineCap="round";
  ctx.beginPath();
  selected.forEach((t,i)=>{
    const r=getTile(t.x,t.y).getBoundingClientRect();
    const cx=r.left+r.width/2;
    const cy=r.top+r.height/2;
    i===0?ctx.moveTo(cx,cy):ctx.lineTo(cx,cy);
  });
  if(pointer) ctx.lineTo(pointer.x,pointer.y);
  ctx.stroke();
}

function clearSel(){
  document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
}

function start(e){
  const t = tileAt(pointerPos(e));
  if(!t) return;
  selected=[t];
  dragging=true;
  getTile(t.x,t.y).classList.add("selected");
}

function move(e){
  if(!dragging) return;
  pointer=pointerPos(e);
  const t = tileAt(pointer);
  const last = selected[selected.length-1];
  if(t && t.color===last.color && neighbors(t,last) &&
     !selected.some(s=>s.x===t.x && s.y===t.y)){
      selected.push(t);
      getTile(t.x,t.y).classList.add("selected");
  }
  drawLine();
}

function end(){
  dragging=false;
  pointer=null;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(selected.length>=2){
    score += selected.length;
    if(selected.length>=4) timeLeft+=5;

    selected.forEach(t=>board[t.y][t.x]=null);
    gravity();
    refill();
    update();
  }
  clearSel();
  selected=[];
}

function gravity(){
  for(let x=0;x<SIZE;x++){
    let empty=0;
    for(let y=SIZE-1;y>=0;y--){
      if(board[y][x]==null) empty++;
      else if(empty){
        board[y+empty][x]=board[y][x];
        board[y][x]=null;
      }
    }
  }
}

function refill(){
  for(let y=0;y<SIZE;y++)
    for(let x=0;x<SIZE;x++)
      if(board[y][x]==null)
        board[y][x]=Math.floor(Math.random()*COLORS.length);
}

function update(){
  for(let y=0;y<SIZE;y++)
    for(let x=0;x<SIZE;x++)
      getTile(x,y).style.background=COLORS[board[y][x]];

  scoreEl.textContent="‚≠ê "+score;
  if(score>highscore){
    highscore=score;
    localStorage.setItem("highscore",highscore);
    highscoreEl.textContent="üèÜ "+highscore;
  }
}

function timer(){
  timeEl.textContent="‚è± "+timeLeft+"s";
  if(timeLeft<=0){
    clearInterval(tInt);
    gameOverEl.style.display="block";
    restartBtn.style.display="block";
  }
  timeLeft--;
}

restartBtn.onclick=()=>{
  score=0;
  timeLeft=60;
  gameOverEl.style.display="none";
  restartBtn.style.display="none";
  createBoard();
  update();
  tInt=setInterval(timer,1000);
};

game.addEventListener("mousedown",start);
window.addEventListener("mousemove",move);
window.addEventListener("mouseup",end);

game.addEventListener("touchstart",e=>{e.preventDefault();start(e);},{passive:false});
window.addEventListener("touchmove",e=>{e.preventDefault();move(e);},{passive:false});
window.addEventListener("touchend",e=>{e.preventDefault();end();},{passive:false});

createBoard();
update();
let tInt=setInterval(timer,1000);
</script>
</body>
</html>
